AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Serverless Workshop Module 4 - Asynchronous Pattern with EventBridge
  and SQS
Parameters:
  UserPool:
    Type: String
    Description: User Pool Id from Module 2
  Service:
    Type: String
    Default: userprofile
  Stage:
    Type: String
    Default: prod
Globals:
  Function:
    Timeout: 20
    Tracing: Active
    Layers:
    - Fn::Sub: arn:aws:lambda:${AWS::Region}:017000801446:layer:AWSLambdaPowertoolsPython:20
  Api:
    TracingEnabled: true
Resources:
  UserAddressesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: ${AWS::StackName}-AddressTable
      AttributeDefinitions:
      - AttributeName: user_id
        AttributeType: S
      - AttributeName: address_id
        AttributeType: S
      KeySchema:
      - AttributeName: user_id
        KeyType: HASH
      - AttributeName: address_id
        KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
  AddressBus:
    Type: AWS::Events::EventBus
    Properties:
      Name:
        Fn::Sub: Address-${AWS::StackName}
  AddUserAddressFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: AddUserAddressFunction
      Handler: add_user_address.lambda_handler
      Runtime: python3.9
      Tracing: Active
      Policies:
        DynamoDBCrudPolicy:
          TableName:
            Ref: UserAddressesTable
      Environment:
        Variables:
          TABLE_NAME:
            Ref: UserAddressesTable
      Events:
        Trigger:
          Type: EventBridgeRule
          Properties:
            EventBusName:
              Ref: AddressBus
            Pattern:
              source:
              - customer-profile
              detail-type:
              - address.added
    Metadata:
      SamResourceId: AddUserAddressFunction
  EditUserAddressFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: EditUserAddressFunction
      Handler: edit_user_address.lambda_handler
      Runtime: python3.9
      Tracing: Active
      Policies:
        DynamoDBCrudPolicy:
          TableName:
            Ref: UserAddressesTable
      Environment:
        Variables:
          TABLE_NAME:
            Ref: UserAddressesTable
          POWERTOOLS_SERVICE_NAME: serverless-workshop
      Events:
        Trigger:
          Type: EventBridgeRule
          Properties:
            EventBusName:
              Ref: AddressBus
            Pattern:
              source:
              - customer-profile
              detail-type:
              - address.updated
    Metadata:
      SamResourceId: EditUserAddressFunction
  DeleteUserAddressFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: DeleteUserAddressFunction
      Handler: delete_user_address.lambda_handler
      Runtime: python3.9
      Tracing: Active
      Policies:
        DynamoDBCrudPolicy:
          TableName:
            Ref: UserAddressesTable
      Environment:
        Variables:
          TABLE_NAME:
            Ref: UserAddressesTable
          POWERTOOLS_SERVICE_NAME: serverless-workshop
      Events:
        Trigger:
          Type: EventBridgeRule
          Properties:
            EventBusName:
              Ref: AddressBus
            Pattern:
              source:
              - customer-profile
              detail-type:
              - address.deleted
    Metadata:
      SamResourceId: DeleteUserAddressFunction
Outputs:
  AddressBus:
    Description: Address Event Bus
    Value:
      Ref: AddressBus
  AddressTable:
    Description: DynamoDB User Address Table
    Value:
      Ref: UserAddressesTable
